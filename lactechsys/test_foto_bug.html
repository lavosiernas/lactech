<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Bug Fotos Compartilhadas - LacTech</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-card {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007bff;
        }
        .placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .error {
            background: #ffe7e7;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }
        .success {
            background: #e7ffe7;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste do Bug de Fotos Compartilhadas</h1>
        
        <div class="info">
            <h3>üìã Objetivo do Teste</h3>
            <p>Este teste verifica se as fotos de perfil est√£o sendo compartilhadas entre usu√°rios diferentes.</p>
            <p><strong>Problema relatado:</strong> Quando o gerente muda sua foto, a foto do √∫ltimo funcion√°rio criado tamb√©m muda.</p>
        </div>

        <div id="loginSection">
            <h3>üîê Login</h3>
            <input type="email" id="email" placeholder="Email" style="padding: 10px; margin: 5px; width: 300px;">
            <input type="password" id="password" placeholder="Senha" style="padding: 10px; margin: 5px; width: 300px;">
            <br>
            <button onclick="login()">Fazer Login</button>
        </div>

        <div id="testSection" style="display: none;">
            <h3>üë• Usu√°rios da Fazenda</h3>
            <button onclick="loadUsers()">üîÑ Recarregar Lista de Usu√°rios</button>
            <button onclick="clearCache()">üóëÔ∏è Limpar Cache do Navegador</button>
            
            <div id="usersList"></div>
            
            <h3>üì∏ Teste de Upload de Foto</h3>
            <div>
                <label>Selecionar usu√°rio para alterar foto:</label>
                <select id="userSelect" style="padding: 10px; margin: 10px; width: 300px;">
                    <option value="">Selecione um usu√°rio...</option>
                </select>
            </div>
            <div>
                <input type="file" id="photoFile" accept="image/*" style="margin: 10px;">
                <button onclick="uploadPhoto()">üì§ Fazer Upload da Foto</button>
            </div>
            
            <div id="results"></div>
        </div>
    </div>

    <script>
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let farmUsers = [];

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('Por favor, preencha email e senha.', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('testSection').style.display = 'block';
                
                showMessage(`Login realizado com sucesso! Usu√°rio: ${currentUser.email}`, 'success');
                await loadUsers();
                
            } catch (error) {
                console.error('Erro no login:', error);
                showMessage('Erro no login: ' + error.message, 'error');
            }
        }

        async function loadUsers() {
            try {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado', 'error');
                    return;
                }
                
                // Buscar farm_id do usu√°rio atual
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', currentUser.id)
                    .single();
                
                if (userError) throw userError;
                
                // Buscar todos os usu√°rios da fazenda
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, name, email, role, profile_photo_url, created_at')
                    .eq('farm_id', userData.farm_id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                farmUsers = users;
                displayUsers(users);
                populateUserSelect(users);
                
                showMessage(`Carregados ${users.length} usu√°rios da fazenda.`, 'success');
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                showMessage('Erro ao carregar usu√°rios: ' + error.message, 'error');
            }
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            
            if (!users || users.length === 0) {
                usersList.innerHTML = '<p>Nenhum usu√°rio encontrado.</p>';
                return;
            }
            
            const usersHtml = users.map(user => {
                const photoElement = user.profile_photo_url ? 
                    `<img src="${user.profile_photo_url}?cache_bust=${Date.now()}" alt="Foto de ${user.name}" class="photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` +
                    `<div class="placeholder" style="display: none;">${user.name.charAt(0)}</div>` :
                    `<div class="placeholder">${user.name.charAt(0)}</div>`;
                
                return `
                    <div class="user-card">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            ${photoElement}
                            <div>
                                <h4>${user.name}</h4>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <p><strong>Fun√ß√£o:</strong> ${user.role}</p>
                                <p><strong>ID:</strong> ${user.id}</p>
                                <p><strong>Foto URL:</strong> ${user.profile_photo_url || 'Sem foto'}</p>
                                <p><strong>Criado em:</strong> ${new Date(user.created_at).toLocaleString('pt-BR')}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            usersList.innerHTML = usersHtml;
        }

        function populateUserSelect(users) {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.role})`;
                select.appendChild(option);
            });
        }

        async function uploadPhoto() {
            const userId = document.getElementById('userSelect').value;
            const fileInput = document.getElementById('photoFile');
            const file = fileInput.files[0];
            
            if (!userId) {
                showMessage('Por favor, selecione um usu√°rio.', 'error');
                return;
            }
            
            if (!file) {
                showMessage('Por favor, selecione uma foto.', 'error');
                return;
            }
            
            try {
                showMessage('Fazendo upload da foto...', 'info');
                
                // Buscar farm_id
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', currentUser.id)
                    .single();
                
                if (userError) throw userError;
                
                // Criar nome √∫nico do arquivo
                const fileExt = file.name.split('.').pop();
                const fileName = `user_${userId}_${Date.now()}.${fileExt}`;
                const filePath = `farm_${userData.farm_id}/${fileName}`;
                
                console.log('Upload details:', {
                    userId,
                    fileName,
                    filePath,
                    farmId: userData.farm_id
                });
                
                // Upload para o storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('profile-photos')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (uploadError) throw uploadError;
                
                // Obter URL p√∫blica
                const { data: { publicUrl } } = supabase.storage
                    .from('profile-photos')
                    .getPublicUrl(filePath);
                
                console.log('Public URL:', publicUrl);
                
                // Atualizar registro do usu√°rio
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ profile_photo_url: publicUrl })
                    .eq('id', userId);
                
                if (updateError) throw updateError;
                
                showMessage('Foto atualizada com sucesso!', 'success');
                
                // Recarregar lista
                await loadUsers();
                
                // Limpar formul√°rio
                document.getElementById('userSelect').value = '';
                fileInput.value = '';
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showMessage('Erro no upload: ' + error.message, 'error');
            }
        }

        function clearCache() {
            // For√ßa recarregamento das imagens
            const images = document.querySelectorAll('.photo');
            images.forEach(img => {
                const src = img.src;
                if (src.includes('?')) {
                    img.src = src.split('?')[0] + '?cache_bust=' + Date.now();
                } else {
                    img.src = src + '?cache_bust=' + Date.now();
                }
            });
            
            showMessage('Cache das imagens limpo!', 'success');
        }

        function showMessage(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
            
            // Auto-scroll para a mensagem
            div.scrollIntoView({ behavior: 'smooth' });
        }

        // Verificar se j√° est√° logado
        window.addEventListener('load', async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('testSection').style.display = 'block';
                showMessage(`Usu√°rio j√° logado: ${user.email}`, 'success');
                await loadUsers();
            }
        });
    </script>
</body>
</html>