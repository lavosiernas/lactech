<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste RLS Seguro</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        .test-result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #ccc; }
        .success-result { border-left-color: green; }
        .error-result { border-left-color: red; }
        code { background: #f0f0f0; padding: 2px 5px; }
    </style>
</head>
<body>
    <h1>üîí Teste RLS Seguro e Funcional</h1>
    
    <div id="status">Carregando...</div>
    
    <div style="margin: 20px 0;">
        <button onclick="testCurrentAccess()" style="background: blue; color: white;">1. Testar Acesso Atual</button>
        <button onclick="implementSecureRLS()" style="background: green; color: white;">2. Implementar RLS Seguro</button>
        <button onclick="testAfterRLS()" style="background: orange; color: white;">3. Testar Ap√≥s RLS</button>
        <button onclick="testLogin()" style="background: purple; color: white;">4. Testar Login</button>
    </div>
    
    <div id="results"></div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://lzqbzztoawjnqwgffhjv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6cWJ6enRvYXdqbnF3Z2ZmaGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MTA5NzUsImV4cCI6MjA2ODI4Njk3NX0.KI7b0vJ0J7i9kN_wNC41SOJOscQc9aqZ6cvInTIn0Z0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}-result`;
            resultDiv.innerHTML = `<h3>${title}</h3>${content}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        async function testCurrentAccess() {
            try {
                addResult('üîç Testando Acesso Atual', 'Verificando se conseguimos acessar a tabela users...');
                
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('id, name, email, role, farm_id')
                    .limit(3);

                if (usersError) {
                    addResult('‚ùå Erro de Acesso', `Erro: ${usersError.message}<br>C√≥digo: ${usersError.code}`, 'error');
                    return false;
                }
                
                addResult('‚úÖ Acesso Funcionando', `Encontrados ${users.length} usu√°rios:<br>${users.map(u => `‚Ä¢ ${u.name} (${u.role})`).join('<br>')}`, 'success');
                return true;
                
            } catch (error) {
                addResult('‚ùå Erro Inesperado', error.message, 'error');
                return false;
            }
        }
        
        async function implementSecureRLS() {
            try {
                addResult('üîß Implementando RLS Seguro', 'Aplicando pol√≠ticas RLS que n√£o quebram o sistema...');
                
                // Como n√£o podemos executar SQL diretamente, vamos simular e dar instru√ß√µes
                addResult('üìã Instru√ß√µes para Implementar RLS', `
                    <strong>Execute no Supabase Dashboard (SQL Editor):</strong><br><br>
                    <code>ALTER TABLE users ENABLE ROW LEVEL SECURITY;</code><br><br>
                    <strong>Depois execute as pol√≠ticas uma por vez:</strong><br><br>
                    <code>-- Pol√≠tica SELECT (mais permissiva)<br>
                    CREATE POLICY users_select_policy ON users<br>
                    FOR SELECT TO authenticated<br>
                    USING (<br>
                    &nbsp;&nbsp;id = auth.uid() OR<br>
                    &nbsp;&nbsp;farm_id IN (SELECT farm_id FROM users WHERE id = auth.uid()) OR<br>
                    &nbsp;&nbsp;NOT EXISTS (SELECT 1 FROM users WHERE id = auth.uid())<br>
                    );</code><br><br>
                    <code>-- Pol√≠tica INSERT<br>
                    CREATE POLICY users_insert_policy ON users<br>
                    FOR INSERT TO authenticated<br>
                    WITH CHECK (<br>
                    &nbsp;&nbsp;farm_id IN (SELECT id FROM farms WHERE setup_completed = false) OR<br>
                    &nbsp;&nbsp;farm_id IN (SELECT farm_id FROM users WHERE id = auth.uid() AND role IN ('proprietario', 'gerente')) OR<br>
                    &nbsp;&nbsp;NOT EXISTS (SELECT 1 FROM users WHERE id = auth.uid())<br>
                    );</code><br><br>
                    <code>-- Pol√≠tica UPDATE<br>
                    CREATE POLICY users_update_policy ON users<br>
                    FOR UPDATE TO authenticated<br>
                    USING (id = auth.uid() OR farm_id IN (SELECT farm_id FROM users WHERE id = auth.uid() AND role IN ('proprietario', 'gerente')))<br>
                    WITH CHECK (id = auth.uid() OR farm_id IN (SELECT farm_id FROM users WHERE id = auth.uid() AND role IN ('proprietario', 'gerente')));</code><br><br>
                    <code>-- Pol√≠tica DELETE<br>
                    CREATE POLICY users_delete_policy ON users<br>
                    FOR DELETE TO authenticated<br>
                    USING (farm_id IN (SELECT farm_id FROM users WHERE id = auth.uid() AND role IN ('proprietario', 'gerente')));</code>
                `, 'warning');
                
                return true;
                
            } catch (error) {
                addResult('‚ùå Erro na Implementa√ß√£o', error.message, 'error');
                return false;
            }
        }
        
        async function testAfterRLS() {
            return await testCurrentAccess();
        }
        
        async function testLogin() {
            try {
                addResult('üîê Testando Processo de Login', 'Simulando processo de autentica√ß√£o...');
                
                // Verificar se h√° usu√°rio logado
                const { data: { user } } = await supabase.auth.getUser();
                
                if (user) {
                    addResult('‚úÖ Usu√°rio Autenticado', `Usu√°rio logado: ${user.email}`, 'success');
                    
                    // Tentar buscar perfil do usu√°rio
                    const { data: profile, error: profileError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (profileError) {
                        addResult('‚ùå Erro ao Buscar Perfil', profileError.message, 'error');
                    } else {
                        addResult('‚úÖ Perfil Encontrado', `Nome: ${profile.name}<br>Role: ${profile.role}<br>Farm ID: ${profile.farm_id}`, 'success');
                    }
                } else {
                    addResult('‚ö†Ô∏è Usu√°rio N√£o Logado', 'Fa√ßa login primeiro para testar completamente.<br><a href="login.html" style="color: blue;">Ir para Login</a>', 'warning');
                }
                
            } catch (error) {
                addResult('‚ùå Erro no Teste de Login', error.message, 'error');
            }
        }
        
        // Teste inicial ao carregar
        window.addEventListener('load', async () => {
            const statusDiv = document.getElementById('status');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (user) {
                    statusDiv.innerHTML = `<span class="success">‚úÖ Conectado como: ${user.email}</span>`;
                } else {
                    statusDiv.innerHTML = `<span class="warning">‚ö†Ô∏è N√£o logado - Alguns testes podem falhar</span>`;
                }
                
                // Teste autom√°tico inicial
                await testCurrentAccess();
                
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">‚ùå Erro de conex√£o: ${error.message}</span>`;
            }
        });
    </script>
</body>
</html>