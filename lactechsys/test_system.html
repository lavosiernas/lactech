<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Sistema - LacTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase_config_fixed.js"></script>
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <style>
        .test-result {
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
        }
        .test-success {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }
        .test-error {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }
        .test-warning {
            background-color: #fffbeb;
            border: 1px solid #fed7aa;
            color: #d97706;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üß™ Teste do Sistema LacTech</h1>
            <p class="text-gray-600">Verifica√ß√£o completa de todas as corre√ß√µes implementadas</p>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üîß Status das Corre√ß√µes</h2>
            <div id="testResults">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto"></div>
                    <p class="mt-2 text-gray-600">Executando testes...</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üìã Testes Manuais</h2>
            <div class="space-y-4">
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="font-semibold text-blue-700">1. Teste de Primeiro Acesso</h3>
                    <p class="text-sm text-gray-600 mb-2">Verifique se consegue criar uma nova fazenda</p>
                    <a href="PrimeiroAcesso.html" class="inline-block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Testar Primeiro Acesso
                    </a>
                </div>

                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-semibold text-green-700">2. Teste de Login</h3>
                    <p class="text-sm text-gray-600 mb-2">Verifique se consegue fazer login</p>
                    <a href="login.html" class="inline-block bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Testar Login
                    </a>
                </div>

                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="font-semibold text-purple-700">3. Teste de Produ√ß√£o</h3>
                    <p class="text-sm text-gray-600 mb-2">Verifique se consegue registrar produ√ß√£o</p>
                    <a href="funcionario.html" class="inline-block bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        Testar Produ√ß√£o
                    </a>
                </div>

                <div class="border-l-4 border-orange-500 pl-4">
                    <h3 class="font-semibold text-orange-700">4. Teste de Gest√£o</h3>
                    <p class="text-sm text-gray-600 mb-2">Verifique se consegue gerenciar usu√°rios</p>
                    <a href="gerente.html" class="inline-block bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                        Testar Gest√£o
                    </a>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">üìä Informa√ß√µes do Sistema</h2>
            <div id="systemInfo" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded">
                        <h3 class="font-semibold text-gray-700">Vers√£o do Sistema</h3>
                        <p class="text-sm text-gray-600">LacTech v1.0.0</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded">
                        <h3 class="font-semibold text-gray-700">Status do Banco</h3>
                        <p class="text-sm text-gray-600" id="dbStatus">Verificando...</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded">
                        <h3 class="font-semibold text-gray-700">Configura√ß√£o RLS</h3>
                        <p class="text-sm text-gray-600" id="rlsStatus">Verificando...</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded">
                        <h3 class="font-semibold text-gray-700">Sincroniza√ß√£o</h3>
                        <p class="text-sm text-gray-600" id="syncStatus">Verificando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para adicionar resultado de teste
        function addTestResult(title, message, type = 'success') {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = `
                <strong>${title}:</strong> ${message}
            `;
            resultsDiv.appendChild(resultDiv);
        }

        // Fun√ß√£o para limpar resultados
        function clearTestResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
        }

        // Teste de conex√£o com Supabase
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase.auth.getUser();
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Erro na conex√£o Supabase:', error);
                return false;
            }
        }

        // Teste das fun√ß√µes RPC
        async function testRPCFunctions() {
            try {
                // Teste da fun√ß√£o check_farm_exists
                const { data: farmCheck, error: farmError } = await supabase
                    .rpc('check_farm_exists', { p_name: 'test', p_cnpj: null });
                
                if (farmError) throw farmError;
                return true;
            } catch (error) {
                console.error('Erro nas fun√ß√µes RPC:', error);
                return false;
            }
        }

        // Teste das pol√≠ticas RLS
        async function testRLSPolicies() {
            try {
                // Teste de acesso √† tabela farms
                const { data, error } = await supabase
                    .from('farms')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Erro nas pol√≠ticas RLS:', error);
                return false;
            }
        }

        // Teste de sincroniza√ß√£o de dados
        async function testDataSync() {
            try {
                // Teste de acesso √† tabela milk_production
                const { data, error } = await supabase
                    .from('milk_production')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o:', error);
                return false;
            }
        }

        // Executar todos os testes
        async function runAllTests() {
            clearTestResults();
            
            // Teste 1: Conex√£o Supabase
            const supabaseOk = await testSupabaseConnection();
            if (supabaseOk) {
                addTestResult('‚úÖ Conex√£o Supabase', 'Conectado com sucesso');
                document.getElementById('dbStatus').textContent = 'Conectado';
            } else {
                addTestResult('‚ùå Conex√£o Supabase', 'Falha na conex√£o', 'error');
                document.getElementById('dbStatus').textContent = 'Erro de conex√£o';
            }

            // Teste 2: Fun√ß√µes RPC
            const rpcOk = await testRPCFunctions();
            if (rpcOk) {
                addTestResult('‚úÖ Fun√ß√µes RPC', 'Todas as fun√ß√µes funcionando');
            } else {
                addTestResult('‚ùå Fun√ß√µes RPC', 'Algumas fun√ß√µes n√£o est√£o dispon√≠veis', 'error');
            }

            // Teste 3: Pol√≠ticas RLS
            const rlsOk = await testRLSPolicies();
            if (rlsOk) {
                addTestResult('‚úÖ Pol√≠ticas RLS', 'Pol√≠ticas configuradas corretamente');
                document.getElementById('rlsStatus').textContent = 'Configurado';
            } else {
                addTestResult('‚ùå Pol√≠ticas RLS', 'Problemas com pol√≠ticas de acesso', 'error');
                document.getElementById('rlsStatus').textContent = 'Erro de configura√ß√£o';
            }

            // Teste 4: Sincroniza√ß√£o
            const syncOk = await testDataSync();
            if (syncOk) {
                addTestResult('‚úÖ Sincroniza√ß√£o de Dados', 'Sincroniza√ß√£o funcionando');
                document.getElementById('syncStatus').textContent = 'Funcionando';
            } else {
                addTestResult('‚ùå Sincroniza√ß√£o de Dados', 'Problemas na sincroniza√ß√£o', 'error');
                document.getElementById('syncStatus').textContent = 'Erro de sincroniza√ß√£o';
            }

            // Resumo final
            const allTestsPassed = supabaseOk && rpcOk && rlsOk && syncOk;
            if (allTestsPassed) {
                addTestResult('üéâ Sistema Completo', 'Todas as corre√ß√µes foram aplicadas com sucesso!', 'success');
            } else {
                addTestResult('‚ö†Ô∏è Sistema Incompleto', 'Algumas corre√ß√µes precisam ser aplicadas', 'warning');
            }
        }

        // Executar testes quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html> 